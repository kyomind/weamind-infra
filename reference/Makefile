APP_SERVICE=app

.PHONY: dev-up clean setup-prod up down deploy migrate revision rollback

# === Container & Image Management ===
dev-up:
	docker compose -f docker-compose.yml -f docker-compose.dev.yml up --build -d

clean:
	docker compose -f docker-compose.yml -f docker-compose.dev.yml down -v

setup-prod:
	docker volume create wea-db-data-prod
	docker network create wea-net || true

up:
	docker compose -f docker-compose.yml -f docker-compose.prod.yml up --build

down:
	docker compose -f docker-compose.yml -f docker-compose.prod.yml down

deploy:
	@echo "ğŸš€ é–‹å§‹éƒ¨ç½²..."
	@echo "ğŸ“¦ å»ºç«‹ä¸¦å•Ÿå‹•å®¹å™¨..."
	docker compose -f docker-compose.yml -f docker-compose.prod.yml up --build -d
	@echo "â³ ç­‰å¾…è³‡æ–™åº«æœå‹™å•Ÿå‹•..."
	@until docker compose exec db pg_isready -U wea_bot -d weamind -q; do \
		echo "ç­‰å¾…è³‡æ–™åº«æº–å‚™ä¸­..."; \
		sleep 2; \
	done
	@echo "ğŸ”„ åŸ·è¡Œè³‡æ–™åº«é·ç§»..."
	@if docker compose exec $(APP_SERVICE) uv run alembic upgrade head; then \
		echo "âœ… è³‡æ–™åº«é·ç§»å®Œæˆ"; \
	else \
		echo "âš ï¸  è³‡æ–™åº«é·ç§»å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ˜¯å¦æœ‰æ–°çš„é·ç§»æª”æ¡ˆæˆ–è³‡æ–™åº«é€£ç·š"; \
	fi
	@echo "âœ… éƒ¨ç½²å®Œæˆï¼"

# === Database Migration ===
migrate:
	docker compose exec $(APP_SERVICE) uv run alembic upgrade head

revision:
	docker compose exec $(APP_SERVICE) uv run alembic revision --autogenerate -m "$(shell git rev-parse --abbrev-ref HEAD)_$(shell date +%Y%m%d_%H%M%S)"

rollback:
	docker compose exec $(APP_SERVICE) uv run alembic downgrade -1
